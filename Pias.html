<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pias</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#151720; --line:#1f2230; --text:#e6e7eb; --muted:#a8adbd;
      --accent:#4da3ff; --ok:#18c29c; --warn:#ff7a7a; --pill:#2a2f42; --btn:#1e2233;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f8fc; --card:#ffffff; --line:#e9ecf2; --text:#11131b; --muted:#5b6180;
        --accent:#2b7de9; --ok:#0a7f63; --warn:#c33; --pill:#eef2fb; --btn:#eef2fb;
      }
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),rgba(0,0,0,0));padding:16px;border-bottom:1px solid var(--line);backdrop-filter:blur(6px)}
    h1{margin:0;font-size:1.25rem;display:flex;align-items:center;gap:8px}
    h2{margin:0 0 8px;font-size:1.05rem}
    main{padding:16px;max-width:980px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
    label{display:block;font-weight:600;margin:12px 0 6px}
    select,input[type="text"],input[type="number"],textarea{width:100%;padding:12px;border:1px solid var(--line);background:transparent;color:var(--text);border-radius:10px}
    button{padding:12px 14px;border:none;border-radius:12px;cursor:pointer}
    .primary{background:var(--accent);color:white}
    .ghost{background:var(--btn);color:var(--text)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 220px}
    .muted{color:var(--muted);font-size:.92rem}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:var(--pill);border:1px solid var(--line);font-size:.82rem}
    .success{border:1px solid rgba(24,194,156,.35);box-shadow:0 0 0 3px rgba(24,194,156,.08) inset}
    .danger{border:1px solid rgba(255,122,122,.35);box-shadow:0 0 0 3px rgba(255,122,122,.08) inset}
    .hidden{display:none}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
    th{font-size:.9rem;color:var(--muted)}
    .footer{text-align:center;color:var(--muted);padding:18px;font-size:.9rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    details>summary{cursor:pointer}
    .titleRow{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .badge{font-size:.78rem;border:1px solid var(--line);padding:4px 8px;border-radius:10px;background:var(--pill)}
    .wheel{font-size:2.2rem;text-align:center;padding:24px 8px;border:1px dashed var(--line);border-radius:12px}
  </style>
</head>
<body>
<header>
  <div class="titleRow">
    <h1>Pias</h1>
    <div class="badge">Sheets-sync</div>
  </div>
  <div class="muted">F√• forslag, logg pr. √∏vingspils, randomiser, og synk felles repertoar.</div>
</header>
<main>
  <section class="card">
    <div class="grid">
      <div>
        <label for="rank">Ansiennitet</label>
        <select id="rank">
          <option value="meconium">Meconium</option>
          <option value="lem_upto_3">Lem ‚â§3 √•r</option>
          <option value="lem_over_3">Lem >3 √•r</option>
          <option value="primarius">Primarius</option>
          <option value="froken">Fr√∏ken</option>
        </select>
      </div>
      <div>
        <label for="sitch">Akkurat n√•</label>
        <select id="sitch">
          <option value="too_little">Det synges for lite</option>
          <option value="too_much">Det synges for mye</option>
        </select>
      </div>
      <div>
        <label for="session">√òvingspils (dato/tekst)</label>
        <input id="session" type="text" placeholder="arrangement, dd/mm/√•√•√•√•">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="suggest" class="primary">üé≤ Foresl√• en sang</button>
      <button id="random" class="ghost">üçÄ Randomiseringsmodus</button>
      <button id="toggleStats" class="ghost">üìà Statistikk</button>
      <button id="toggleSettings" class="ghost">‚öôÔ∏è Innstillinger</button>
    </div>
  </section>

  <section id="resultBox" class="card hidden"></section>

  <section id="randomBox" class="card hidden">
    <h2>üçÄ Randomiseringsmodus</h2>
    <p class="muted">Spinn hjulet! Filtrerer automatisk p√• situasjon/ansiennitet.</p>
    <div id="wheel" class="wheel">Trykk SPINN</div>
    <div class="row" style="margin-top:10px">
      <button id="spin" class="primary">üéØ SPINN</button>
      <button id="logSpin" class="ghost" disabled>üìù Logg valgt</button>
    </div>
  </section>

  <section id="statsBox" class="card hidden">
    <div class="titleRow"><h2>üìà Statistikk</h2>
      <div class="row" style="flex:0 0 auto">
        <button id="refreshCloud" class="ghost">üîÑ Hent fra skyen</button>
        <button id="exportLogLocal" class="ghost">‚¨áÔ∏è Lokal CSV</button>
      </div>
    </div>
    <div id="statsSummary" class="muted" style="margin-top:8px"></div>
    <div class="grid" style="margin-top:8px">
      <div class="card">
        <h3>M√•nedens sang</h3>
        <div id="songOfMonth">‚Äî</div>
      </div>
      <div class="card">
        <h3>Mest sunget (Sky, topp 10)</h3>
        <table id="topCloud"></table>
      </div>
      <div class="card">
        <h3>Mest sunget (Denne √∏vingspilsen)</h3>
        <table id="topThisSession"></table>
      </div>
    </div>
    <div class="card">
      <h3>R√• logg (siste 100 fra sky)</h3>
      <table id="rawCloud"></table>
    </div>
  </section>

  <section id="settingsBox" class="card hidden">
    <h2>‚öôÔ∏è Innstillinger (Sheets + Admin-l√•s)</h2>
    <p class="muted">Repertoar synkes fra Google Sheet og kan oppdateres i skyen av de med admin-kode.</p>
    <div class="grid">
      <div><label>Web App URL</label><input id="cfg_url" type="text" placeholder="https://script.google.com/macros/s/AKfy.../exec"></div>
      <div><label>API-n√∏kkel (valgfri)</label><input id="cfg_key" type="text" placeholder="hemmelig-n√∏kkel"></div>
      <div><label>Admin-kode (for √• endre repertoar)</label><input id="cfg_admin" type="text" placeholder="kode som settes i Apps Script"></div>
      <div><label>Auto-logg til sky</label><select id="cfg_autolog"><option value="0">Av</option><option value="1">P√•</option></select></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="saveCfg" class="primary">üíæ Lagre</button>
      <button id="testCfg" class="ghost">üß™ Test tilkobling</button>
      <button id="pullRep" class="ghost">‚¨áÔ∏è Hent repertoar fra sky</button>
      <button id="pushRep" class="ghost">‚¨ÜÔ∏è Last opp repertoar (krever admin-kode)</button>
    </div>
    <details style="margin-top:12px">
      <summary>Oppsett for Google Sheets (logg + repertoar)</summary>
      <ol>
        <li>Opprett et Google Sheet med ark: <code>log</code> og <code>repertoire</code>.</li>
        <li>Extensions ‚Üí Apps Script ‚Üí lim inn skriptet under og sett <code>SHEET_ID</code>, <code>API_KEY</code> (valgfri) og <code>ADMIN_CODE</code>.</li>
        <li>Deploy som Web app med tilgang ‚ÄúAnyone with the link‚Äù.</li>
      </ol>
      <pre style="white-space:pre-wrap;background:var(--pill);padding:12px;border-radius:8px;border:1px solid var(--line)">
// Google Apps Script (Code.gs) ‚Äî Logg + Repertoar
const SHEET_ID = "SETT_INN_SHEET_ID";
const API_KEY = "valgfri-hemmelig-nokkel"; // kan v√¶re ""
const ADMIN_CODE = "sett-admin-kode-her";   // kreves for endring av repertoar
const LOG_HEADERS = ["timestamp","session","song_id","title","rank","situation","energy","tags","ua"];
const REP_HEADERS = ["id","title","tags_csv","energy","difficulty","length","call_when","weight","cooldown_min","version","updated_at"];

function _open(){ return SpreadsheetApp.openById(SHEET_ID); }
function _sheet(name, headers){
  const ss=_open(); const sh=ss.getSheetByName(name)||ss.insertSheet(name);
  if (sh.getLastRow()===0 && headers) sh.appendRow(headers);
  return sh;
}
function _json(obj, code){ return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON); }
function _auth(e){
  const key = (e.parameter?.api_key) || (e.postData ? JSON.parse(e.postData.contents).api_key : "");
  if(API_KEY && key !== API_KEY) throw new Error("unauthorized");
}
function doPost(e){
  try{
    _auth(e);
    const body = JSON.parse(e.postData.contents) || {};
    if(body.action==="append_log"){
      const sh=_sheet("log", LOG_HEADERS);
      const r = body.row||{};
      const values=[r.timestamp||new Date().toISOString(), r.session||"", r.song_id||"", r.title||"", r.rank||"", r.situation||"", r.energy||"", (r.tags||[]).join(";"), r.ua||""];
      sh.appendRow(values);
      return _json({ok:true});
    }
    if(body.action==="push_repertoire"){
      if((body.admin_code||"") !== ADMIN_CODE) throw new Error("forbidden");
      const arr = body.repertoire||[];
      const sh=_sheet("repertoire", REP_HEADERS);
      sh.clear();
      sh.appendRow(REP_HEADERS);
      const now = new Date().toISOString();
      let version = (body.version||0)+1;
      arr.forEach(item=>{
        sh.appendRow([item.id,item.title,(item.tags||[]).join(","),item.energy,item.difficulty,item.length,item.call_when,item.weight,item.cooldown_min,version,now]);
      });
      return _json({ok:true, version, updated_at:now});
    }
    return _json({ok:false,error:"unknown_action"});
  }catch(err){ return _json({ok:false,error:String(err)}); }
}
function doGet(e){
  try{
    _auth(e);
    const shL=_sheet("log", LOG_HEADERS);
    const shR=_sheet("repertoire", REP_HEADERS);

    const params=e.parameter||{};
    if(params.action==="stats"){
      const rows=shL.getDataRange().getValues(); const [head,...data]=rows;
      const lastN = data.slice(-100).map(r=>Object.fromEntries(head.map((h,i)=>[h,r[i]]))).reverse();
      // m√•nedens sang (innev√¶rende m√•ned i regnearkets tidssone)
      const now = new Date(); const m = now.getMonth(); const y = now.getFullYear();
      const thisMonth = data.filter(r=>{
        const d = new Date(r[0]); return d.getMonth()===m && d.getFullYear()===y;
      });
      const counts={}; thisMonth.forEach(r=>{ const title=r[3]; counts[title]=(counts[title]||0)+1; });
      const monthTop = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0] || null;
      // topp 10 total (siste 100)
      const c10={}; lastN.forEach(r=>{ c10[r.title]=(c10[r.title]||0)+1; });
      const top = Object.entries(c10).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([title,count])=>({title,count}));
      return _json({ok:true, rows:lastN, total:data.length, monthTop: monthTop ? {title:monthTop[0], count:monthTop[1]} : null, top});
    }
    if(params.action==="repertoire"){
      const rows=shR.getDataRange().getValues(); const [head,...data]=rows;
      const items = data.map(r=>Object.fromEntries(head.map((h,i)=>[h,r[i]])));
      const version = items[0]?.version||0; const updated_at = items[0]?.updated_at||"";
      // map to app format
      const rep = items.map(x=>({
        id:String(x.id||"").trim(),
        title:String(x.title||"").trim(),
        tags:String(x.tags_csv||"").split(",").map(s=>s.trim()).filter(Boolean),
        energy:String(x.energy||"medium"),
        difficulty: Number(x.difficulty||2),
        length: Number(x.length||150),
        call_when: String(x.call_when||"both"),
        weight: Number(x.weight||7),
        cooldown_min: Number(x.cooldown_min||45),
      }));
      return _json({ok:true, version, updated_at, repertoire: rep});
    }
    return _json({ok:false,error:"unknown_action"});
  }catch(err){ return _json({ok:false,error:String(err)}); }
}
      </pre>
    </details>
  </section>

  <div class="footer">Pias ¬© - et Foetalt produkt.</div>
</main>

<script>
// ====== Rank labels ======
const RANK_LABEL = {meconium:"Meconium",lem_upto_3:"Lem ‚â§3 √•r",lem_over_3:"Lem >3 √•r",primarius:"Primarius",froken:"Fr√∏ken"};

// ====== Local storage ======
function loadCfg(){ try{ return JSON.parse(localStorage.getItem("pias_cfg")||"{}"); }catch(e){ return {}; } }
function saveCfg(c){ localStorage.setItem("pias_cfg", JSON.stringify(c)); }
function loadDB(){ try{ return JSON.parse(localStorage.getItem("pias_songs")||"[]"); }catch(e){ return []; } }
function saveDB(db){ localStorage.setItem("pias_songs", JSON.stringify(db)); }
function loadMeta(){ try{ return JSON.parse(localStorage.getItem("pias_meta")||"{}"); }catch(e){ return {}; } }
function saveMeta(m){ localStorage.setItem("pias_meta", JSON.stringify(m)); }
function loadLog(){ try{ return JSON.parse(localStorage.getItem("pias_history")||"[]"); }catch(e){ return []; } }
function saveLog(arr){ localStorage.setItem("pias_history", JSON.stringify(arr)); }

// ====== Suggestion rules ======
function shouldSing(rank, situation){ if(situation==="too_much"){ if(rank==="meconium") return {ok:false,reason:"Meconium: dropp ny sang n√•r det allerede synges mye."}; return {ok:true}; } return {ok:true}; }
function filtersFor(rank, situation){
  if(situation==="too_much"){
    if(rank==="lem_upto_3") return s => (s.energy!=="high") && s.length<=180;
    if(rank==="lem_over_3") return s => s.energy!=="high";
    if(rank==="primarius"||rank==="froken") return s => (s.energy==="low" || s.tags.includes("klassiker") || s.tags.includes("hjerteknuser"));
  } else { return s=>true; }
  return s=>true;
}
function callWindowOk(song, situation){ return song.call_when==="both" || (song.call_when==="over" && situation==="too_much") || (song.call_when==="under" && situation==="too_little"); }
function scoreSong(song){
  const last = song.last_sung||0, cd=song.cooldown_min||45, minutes=(Date.now()-last)/60000;
  const penalty = minutes<cd ? (1-minutes/cd)*5 : 0;
  return (song.weight||7) - penalty + Math.random()*0.5;
}
function suggestSong(rank, situation, db){
  const rule = shouldSing(rank,situation);
  if(!rule.ok) return {sing:false, reason:rule.reason};
  const pred=filtersFor(rank,situation);
  const cands=db.filter(s=>callWindowOk(s,situation)).filter(pred);
  if(!cands.length) return {sing:false,reason:"Fant ingen passende sang n√•. Dropp sang."};
  cands.sort((a,b)=>scoreSong(b)-scoreSong(a));
  const choice=cands[0]; choice.last_sung=Date.now(); saveDB(db); return {sing:true, song:choice};
}

// ====== Cloud helpers ======
async function cloudFetch(action, params={}){
  const cfg=loadCfg(); if(!cfg.url) throw new Error("Konfigurer Web App URL");
  const u=new URL(cfg.url); u.searchParams.set("action", action); if(cfg.key) u.searchParams.set("api_key", cfg.key);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
  const r=await fetch(u.toString()); const j=await r.json(); if(!j.ok) throw new Error(j.error||"Ukjent feil"); return j;
}
async function cloudPost(payload){
  const cfg=loadCfg(); if(!cfg.url) throw new Error("Konfigurer Web App URL");
  payload.api_key = cfg.key||"";
  const r = await fetch(cfg.url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
  const j = await r.json(); if(!j.ok) throw new Error(j.error||"Ukjent feil"); return j;
}

// ====== Repertoire sync ======
async function pullRepertoire(){
  const j = await cloudFetch("repertoire");
  saveDB(j.repertoire||[]);
  const meta = loadMeta(); meta.rep_version = j.version||0; meta.rep_updated_at = j.updated_at||""; saveMeta(meta);
  toast("Repertoar oppdatert fra sky");
  return j;
}
async function pushRepertoire(){
  const cfg=loadCfg(); if(!cfg.admin) throw new Error("Sett admin-kode i innstillinger");
  const rep = loadDB();
  const meta = loadMeta();
  const j = await cloudPost({action:"push_repertoire", admin_code: cfg.admin, version: meta.rep_version||0, repertoire: rep});
  meta.rep_version = j.version; meta.rep_updated_at = j.updated_at; saveMeta(meta);
  toast("Repertoar lastet opp");
  return j;
}

// ====== Logging (local + cloud) ======
function localLog(s){
  const rank=document.getElementById("rank").value; const sit=document.getElementById("sitch").value; const session=document.getElementById("session").value.trim()||new Date().toISOString().slice(0,10);
  const log=loadLog(); log.unshift({timestamp:new Date().toISOString(), session, song_id:s.id, title:s.title, rank, situation:sit}); saveLog(log); toast("Logget lokalt");
}
async function cloudLog(s, quiet=false){
  const rank=document.getElementById("rank").value;
  const sit=document.getElementById("sitch").value;
  const sessionInput=document.getElementById("session").value.trim();
  // leave session blank in the cloud if user did not type it
  const session = sessionInput || "";
  const row={timestamp:new Date().toISOString(), session, song_id:s.id, title:s.title, rank, situation:sit, energy:s.energy, tags:s.tags, ua:navigator.userAgent};
  try{ await cloudPost({action:"append_log", row}); toast(quiet?"Auto-logget ‚òÅÔ∏è":"Logget til sky ‚òÅÔ∏è"); }catch(e){ toast("Skyfeil: "+e.message); }
};
  try{ await cloudPost({action:"append_log", row}); toast(quiet?"Auto-logget ‚òÅÔ∏è":"Logget til sky ‚òÅÔ∏è"); }catch(e){ toast("Skyfeil: "+e.message); }
}

// ====== UI helpers ======
function pill(text){ return `<span class="pill">${text}</span>` }
function toast(msg){
  const t=document.createElement("div"); t.textContent=msg;
  t.style.position="fixed"; t.style.bottom="16px"; t.style.left="50%"; t.style.transform="translateX(-50%)";
  t.style.background="var(--card)"; t.style.border="1px solid var(--line)"; t.style.padding="10px 14px"; t.style.borderRadius="10px";
  t.style.boxShadow="0 8px 30px rgba(0,0,0,.2)"; t.style.zIndex=9999;
  document.body.appendChild(t); setTimeout(()=>t.remove(), 1400);
}

// ====== Renderers ======
function renderSuggestion(res){
  const out=document.getElementById("resultBox"); out.className="card";
  if(!res.sing){
    out.classList.add("danger"); out.innerHTML = `<h3>üö´ Ikke syng n√•</h3><p class="muted">${res.reason}</p>`;
  } else {
    const s=res.song;
    out.classList.add("success");
    out.innerHTML = `
      <h3>‚úÖ Syng: ${s.title}</h3>
      <p>${pill(s.energy)} ${pill("diff "+s.difficulty)} ${pill(s.length+"s")} ${pill(s.call_when)}</p>
      <p class="muted">Tags: ${(s.tags||[]).join(", ")||"‚Äî"}</p>
      <div class="row">
        <button id="logLocal" class="primary">üìù Logg lokalt</button>
        <button id="logCloud" class="ghost">‚òÅÔ∏è Logg til sky</button>
      </div>
    `;
    document.getElementById("logLocal").addEventListener("click",()=> localLog(s));
    document.getElementById("logCloud").addEventListener("click",()=> cloudLog(s));
    const cfg=loadCfg(); if(cfg.autolog==="1"){ cloudLog(s,true); }
  }
  out.classList.remove("hidden");
}

function renderStatsCloud(j){
  // summary
  document.getElementById("statsSummary").textContent = `Sky-logg totalt: ${j.total}. Viser siste ${j.rows.length}.`;
  // song of month
  const som = j.monthTop ? `${j.monthTop.title} (${j.monthTop.count})` : "‚Äî";
  document.getElementById("songOfMonth").textContent = som;
  // top 10
  let h="<tr><th>#</th><th>Sang</th><th>Antall</th></tr>";
  (j.top||[]).forEach((r,i)=> h+=`<tr><td>${i+1}</td><td>${r.title}</td><td>${r.count}</td></tr>`);
  if(!j.top?.length) h+=`<tr><td colspan="3" class="muted">Ingen data.</td></tr>`;
  document.getElementById("topCloud").innerHTML = h;
  // raw (last 100)
  let rh="<tr><th>Tid</th><th>Session</th><th>Sang</th><th>Rank</th><th>Situasjon</th></tr>";
  (j.rows||[]).forEach(r=>{ rh+=`<tr><td class="muted">${r.timestamp}</td><td>${r.session||""}</td><td>${r.title}</td><td>${r.rank}</td><td>${r.situation==="too_little"?"For lite":"For mye"}</td></tr>`; });
  document.getElementById("rawCloud").innerHTML = rh;
}

function renderTopThisSession(){
  const sessionText = document.getElementById("session").value.trim();
  const log = loadLog();
  let filtered;
  if(sessionText){
    filtered = log.filter(r=>r.session===sessionText);
  } else {
    // use today's calendar date in local timezone
    const today = new Date();
    const d = today.getDate().toString().padStart(2,'0');
    const m = (today.getMonth()+1).toString().padStart(2,'0');
    const y = today.getFullYear();
    const todayStr = `${d}/${m}/${y}`;
    // filter by same calendar date based on each log's timestamp
    filtered = log.filter(r=>{
      const dt = new Date(r.timestamp);
      const dd = dt.getDate().toString().padStart(2,'0');
      const mm = (dt.getMonth()+1).toString().padStart(2,'0');
      const yy = dt.getFullYear();
      const cmp = `${dd}/${mm}/${yy}`;
      return cmp === todayStr;
    });
  }
  const counts = new Map(); for(const r of filtered) counts.set(r.title, (counts.get(r.title)||0)+1);
  const top=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
  let h="<tr><th>#</th><th>Sang</th><th>Antall</th></tr>";
  top.forEach(([title,c],i)=>{ h+=`<tr><td>${i+1}</td><td>${title}</td><td>${c}</td></tr>`; });
  if(!top.length) h+=`<tr><td colspan="3" class="muted">Ingen lokal data for valgt dag.</td></tr>`;
  document.getElementById("topThisSession").innerHTML=h;
}</td><td>${title}</td><td>${c}</td></tr>`; });
  if(!top.length) h+=`<tr><td colspan="3" class="muted">Ingen lokal data for denne √∏vingspilsen.</td></tr>`;
  document.getElementById("topThisSession").innerHTML=h;
}

// ====== Randomizer ======
let lastSpin=null;
function openRandom(){
  document.getElementById("randomBox").classList.remove("hidden");
  document.getElementById("wheel").textContent="Trykk SPINN";
  document.getElementById("logSpin").disabled = true;
}
function spinWheel(){
  const db = loadDB();
  const rank=document.getElementById("rank").value; const sit=document.getElementById("sitch").value;
  const pred=filtersFor(rank,sit); const pool=db.filter(s=>callWindowOk(s,sit)).filter(pred);
  if(pool.length===0){ toast("Ingen kandidater"); return; }
  // simple animation
  const wheel=document.getElementById("wheel");
  let t=0, steps=20+Math.floor(Math.random()*10);
  const timer=setInterval(()=>{
    const pick=pool[Math.floor(Math.random()*pool.length)];
    wheel.textContent = pick.title;
    t++; if(t>=steps){ clearInterval(timer); lastSpin=pick; document.getElementById("logSpin").disabled=false; }
  }, 80);
}
function logSpin(){
  if(!lastSpin) return;
  localLog(lastSpin);
  const cfg=loadCfg(); if(cfg.autolog==="1"){ cloudLog(lastSpin,true); }
  toast("Random-valg logget");
}

// ====== Events ======
document.getElementById("suggest").addEventListener("click", async ()=>{
  const db = loadDB(); if(!db.length){ try{ await pullRepertoire(); }catch(e){} }
  const rank=document.getElementById("rank").value; const sit=document.getElementById("sitch").value;
  renderSuggestion(suggestSong(rank,sit, loadDB()));
});
document.getElementById("random").addEventListener("click", openRandom);
document.getElementById("spin").addEventListener("click", spinWheel);
document.getElementById("logSpin").addEventListener("click", logSpin);

document.getElementById("toggleStats").addEventListener("click", async ()=>{
  const box=document.getElementById("statsBox"); box.classList.toggle("hidden");
  if(!box.classList.contains("hidden")){
    try{ const j=await cloudFetch("stats"); renderStatsCloud(j); } catch(e){ document.getElementById("statsSummary").textContent="Kunne ikke hente sky-data: "+e.message; }
    renderTopThisSession();
  }
});
document.getElementById("toggleSettings").addEventListener("click", ()=>{
  document.getElementById("settingsBox").classList.toggle("hidden");
});
document.getElementById("refreshCloud").addEventListener("click", async ()=>{
  try{ const j=await cloudFetch("stats"); renderStatsCloud(j); toast("Oppdatert fra sky"); }catch(e){ toast("Feil: "+e.message); }
});
document.getElementById("exportLogLocal").addEventListener("click", ()=>{
  const log = loadLog(); const rows=[["timestamp","session","song_id","title","rank","situation"]];
  log.forEach(r=>rows.push([r.timestamp,r.session,r.song_id,r.title,r.rank,r.situation]));
  const csv = rows.map(r=>r.map(x=>`"${String(x??"").replaceAll('"','""')}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="pias_logg_lokal.csv"; a.click(); URL.revokeObjectURL(url);
});
document.getElementById("saveCfg").addEventListener("click", ()=>{
  const url=document.getElementById("cfg_url").value.trim();
  const key=document.getElementById("cfg_key").value.trim();
  const admin=document.getElementById("cfg_admin").value.trim();
  const autolog=document.getElementById("cfg_autolog").value;
  saveCfg({url,key,admin,autolog});
  toast("Lagret innstillinger");
});
document.getElementById("testCfg").addEventListener("click", async ()=>{
  try{ const j=await cloudFetch("stats"); renderStatsCloud(j); toast("Tilkobling OK"); }catch(e){ toast("Feil: "+e.message); }
});
document.getElementById("pullRep").addEventListener("click", async ()=>{
  try{ await pullRepertoire(); toast("Hentet repertoar"); }catch(e){ toast("Feil: "+e.message); }
});
document.getElementById("pushRep").addEventListener("click", async ()=>{
  try{ await pushRepertoire(); }catch(e){ toast("Feil: "+e.message); }
});

// Prefill session as today's date
document.getElementById("session").value = "";

// Boot hint: try to pull repertoire once on first run
(async ()=>{
  if(!loadDB().length){
    try{ await pullRepertoire(); }catch(e){ /* ignore */ }
  }
})();

function toast(msg){
  const t=document.createElement("div"); t.textContent=msg;
  t.style.position="fixed"; t.style.bottom="16px"; t.style.left="50%"; t.style.transform="translateX(-50%)";
  t.style.background="var(--card)"; t.style.border="1px solid var(--line)"; t.style.padding="10px 14px"; t.style.borderRadius="10px";
  t.style.boxShadow="0 8px 30px rgba(0,0,0,.2)"; t.style.zIndex=9999;
  document.body.appendChild(t); setTimeout(()=>t.remove(), 1400);
}
</script>
</body>
</html>
